({168:function(){var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(a,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function o(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}c((n=n.apply(e,t||[])).next())}))};function t(){return{colors:figma.getLocalPaintStyles().map((e=>({name:e.name,description:e.description,paints:e.paints.map((e=>{if("SOLID"===e.type){const{r:t,g:i,b:n}=e.color;return{type:"SOLID",color:{r:Math.round(255*t),g:Math.round(255*i),b:Math.round(255*n),a:e.opacity||1}}}return{type:e.type}}))}))),texts:figma.getLocalTextStyles().map((e=>({name:e.name,description:e.description,fontName:e.fontName,fontSize:e.fontSize,letterSpacing:e.letterSpacing,lineHeight:e.lineHeight,paragraphIndent:e.paragraphIndent,paragraphSpacing:e.paragraphSpacing,textCase:e.textCase,textDecoration:e.textDecoration}))),effects:figma.getLocalEffectStyles().map((e=>({name:e.name,description:e.description,effects:e.effects})))}}function i(e){const t={id:e.id,name:e.name,type:e.type,visible:e.visible};let n=Object.assign({},t);if("fills"in e&&Array.isArray(e.fills))try{n.fills=e.fills}catch(e){console.error("Error getting fills:",e)}if("TEXT"===e.type)try{const t=e;n.characters=t.characters,n.fontSize=t.fontSize,n.fontName=t.fontName}catch(e){console.error("Error getting text properties:",e)}const a=e.absoluteBoundingBox;a&&(n.width=a.width,n.height=a.height,n.x=a.x,n.y=a.y);const r=e;if("children"in e&&Array.isArray(r.children))try{const e=10,t=Array.from(r.children).slice(0,e).map((e=>i(e)));n.children=t,n.childrenCount=r.children.length,n.truncated=r.children.length>e}catch(e){console.error("Error processing children:",e)}return n}function n(t){return e(this,void 0,void 0,(function*(){try{const e=yield t.exportAsync({format:"PNG",constraint:{type:"SCALE",value:1}});return`data:image/png;base64,${figma.base64Encode(e)}`}catch(e){return console.error("Error exporting node:",e),null}}))}function a(t=!1,a=!1,o){return e(this,void 0,void 0,(function*(){try{const e=figma.currentPage.selection.map((e=>{console.log(e);const t={id:e.id,name:e.name,type:e.type,visible:e.visible};if("fills"in e)return Object.assign(Object.assign({},t),{fills:e.fills});try{if("characters"in e){const i=e;return Object.assign(Object.assign({},t),{characters:i.characters,fontSize:i.fontSize||"unknown",fontWeight:i.fontWeight||"unknown",fontName:i.fontName||{family:"unknown",style:"unknown"}})}}catch(e){}return t}));if("coding"===o){const i=figma.currentPage.selection.map((e=>r(e))),o=e.map(((e,t)=>Object.assign(Object.assign({},e),{detailedStyles:i[t]})));if(t){const e=figma.currentPage.selection.map((e=>s(e))),t=o.map(((t,i)=>Object.assign(Object.assign({},t),{hierarchy:e[i]})));if(a){const e=figma.currentPage.selection.map((e=>n(e))),i=yield Promise.all(e),a=t.map(((e,t)=>Object.assign(Object.assign({},e),{imageData:i[t]})));return JSON.parse(JSON.stringify(a,((e,t)=>("imageData"===e&&"string"==typeof t&&t.startsWith("data:image"),t))))}return JSON.parse(JSON.stringify(t))}if(a){const e=figma.currentPage.selection.map((e=>n(e))),t=yield Promise.all(e),i=o.map(((e,i)=>Object.assign(Object.assign({},e),{imageData:t[i]})));return JSON.parse(JSON.stringify(i,((e,t)=>("imageData"===e&&"string"==typeof t&&t.startsWith("data:image"),t))))}return JSON.parse(JSON.stringify(o))}if(t){const t=figma.currentPage.selection.map((e=>i(e))),r=e.map(((e,i)=>Object.assign(Object.assign({},e),{hierarchy:t[i]})));if(a){const e=figma.currentPage.selection.map((e=>n(e))),t=yield Promise.all(e),i=r.map(((e,i)=>Object.assign(Object.assign({},e),{imageData:t[i]})));return JSON.parse(JSON.stringify(i,((e,t)=>("imageData"===e&&"string"==typeof t&&t.startsWith("data:image"),t))))}return JSON.parse(JSON.stringify(r))}if(a){const t=figma.currentPage.selection.map((e=>n(e))),i=yield Promise.all(t),a=e.map(((e,t)=>Object.assign(Object.assign({},e),{imageData:i[t]})));return JSON.parse(JSON.stringify(a,((e,t)=>("imageData"===e&&"string"==typeof t&&t.startsWith("data:image"),t))))}return JSON.parse(JSON.stringify(e))}catch(e){return console.error("選択情報取得エラー:",e),figma.currentPage.selection.map((e=>({id:e.id,name:e.name,type:e.type})))}}))}function r(e){try{const t={};if("absoluteBoundingBox"in e&&e.absoluteBoundingBox?t.bounds={x:e.absoluteBoundingBox.x,y:e.absoluteBoundingBox.y,width:e.absoluteBoundingBox.width,height:e.absoluteBoundingBox.height}:"x"in e&&"y"in e&&"width"in e&&"height"in e&&(t.bounds={x:e.x,y:e.y,width:e.width,height:e.height}),"FRAME"===e.type||"GROUP"===e.type||"INSTANCE"===e.type){const i=e;"layoutMode"in i&&(t.layout={mode:i.layoutMode,direction:"layoutDirection"in i?i.layoutDirection:null,alignment:"primaryAxisAlignItems"in i?{primaryAxis:i.primaryAxisAlignItems,counterAxis:i.counterAxisAlignItems}:null,padding:"paddingTop"in i?{top:i.paddingTop,right:i.paddingRight,bottom:i.paddingBottom,left:i.paddingLeft}:null,spacing:"itemSpacing"in i?i.itemSpacing:null}),"backgrounds"in i&&Array.isArray(i.backgrounds)&&(t.backgrounds=i.backgrounds),"effects"in i&&Array.isArray(i.effects)&&(t.effects=i.effects),"strokes"in i&&Array.isArray(i.strokes)&&(t.strokes=i.strokes,"strokeWeight"in i&&(t.strokeWeight=i.strokeWeight),"strokeAlign"in i&&(t.strokeAlign=i.strokeAlign)),"cornerRadius"in i&&(t.cornerRadius=i.cornerRadius)}if("TEXT"===e.type){const i=e;t.text={characters:i.characters,fontSize:i.fontSize,fontName:i.fontName,fontWeight:i.fontWeight,letterSpacing:i.letterSpacing,lineHeight:i.lineHeight,paragraphIndent:i.paragraphIndent,paragraphSpacing:i.paragraphSpacing,textAlignHorizontal:i.textAlignHorizontal,textAlignVertical:i.textAlignVertical,textCase:i.textCase,textDecoration:i.textDecoration,textAutoResize:i.textAutoResize},"fills"in i&&Array.isArray(i.fills)&&(t.text.fills=i.fills)}return"VECTOR"!==e.type&&"LINE"!==e.type&&"ELLIPSE"!==e.type&&"POLYGON"!==e.type&&"STAR"!==e.type&&"RECTANGLE"!==e.type||("fills"in e&&Array.isArray(e.fills)&&(t.fills=e.fills),"strokes"in e&&Array.isArray(e.strokes)&&(t.strokes=e.strokes,"strokeWeight"in e&&(t.strokeWeight=e.strokeWeight),"strokeAlign"in e&&(t.strokeAlign=e.strokeAlign)),"RECTANGLE"===e.type&&"cornerRadius"in e&&(t.cornerRadius=e.cornerRadius)),"COMPONENT"!==e.type&&"INSTANCE"!==e.type||(t.component={id:e.id,name:e.name},"INSTANCE"===e.type&&"componentId"in e&&(t.component.componentId=e.componentId)),JSON.parse(JSON.stringify(t))}catch(t){return console.error("詳細情報取得エラー:",t),{id:e.id,type:e.type,name:e.name}}}function s(e){try{const t=i(e),n=r(e),a=Object.assign(Object.assign({},t),{detailedStyles:n}),o=e;if("children"in e&&Array.isArray(o.children))try{const e=10,t=Array.from(o.children).slice(0,e).map((e=>s(e)));a.children=t,a.childrenCount=o.children.length,a.truncated=o.children.length>e}catch(e){console.error("Error processing children with styles:",e)}return JSON.parse(JSON.stringify(a))}catch(t){return console.error("再帰的詳細情報取得エラー:",t),{id:e.id,type:e.type,name:e.name}}}figma.showUI(__html__,{width:550,height:600}),figma.on("selectionchange",(()=>e(this,void 0,void 0,(function*(){try{const e=(yield figma.clientStorage.getAsync("include-children"))||!1,t=(yield figma.clientStorage.getAsync("include-images"))||!1,i=yield a(e,t);figma.ui.postMessage({type:"selection-update",selection:i})}catch(e){console.error("Error in selectionchange handler:",e),figma.ui.postMessage({type:"selection-update",selection:figma.currentPage.selection.map((e=>({id:e.id,name:e.name,type:e.type})))})}})))),figma.clientStorage.getAsync("gemini-api-key").then((e=>{figma.ui.postMessage({type:"api-key",apiKey:e||""})})),figma.clientStorage.getAsync("coding-prompt").then((e=>{figma.ui.postMessage({type:"coding-prompt",codingPrompt:e||"FLOCSS"})})),figma.ui.onmessage=i=>e(this,void 0,void 0,(function*(){if("ui-loaded"===i.type){console.log("UI loaded successfully");try{const e=(yield figma.clientStorage.getAsync("include-children"))||!1,i=(yield figma.clientStorage.getAsync("include-images"))||!1,n=(yield figma.clientStorage.getAsync("coding-prompt"))||"FLOCSS",r="coding",s=yield a(e,i,r);figma.ui.postMessage({type:"init-data",designTokens:t(),selection:s}),figma.ui.postMessage({type:"coding-prompt",codingPrompt:n})}catch(e){console.error("Error sending initial data:",e),figma.ui.postMessage({type:"init-data",designTokens:t(),selection:figma.currentPage.selection.map((e=>({id:e.id,name:e.name,type:e.type})))})}}else if("update-selection-settings"===i.type){const{includeChildren:e,includeImages:t,templateType:n}=i;yield figma.clientStorage.setAsync("include-children",e),yield figma.clientStorage.setAsync("include-images",t);try{const i=yield a(e,t,n);figma.ui.postMessage({type:"selection-update",selection:i})}catch(e){console.error("Error updating selection with new settings:",e),figma.notify("選択情報の更新中にエラーが発生しました",{error:!0})}}else if("get-api-key"===i.type)try{const e=(yield figma.clientStorage.getAsync("gemini-api-key"))||"";figma.ui.postMessage({type:"api-key-result",apiKey:e})}catch(e){console.error("APIキー取得エラー:",e),figma.ui.postMessage({type:"api-key-result",apiKey:""})}else if("save-api-key"===i.type)try{yield figma.clientStorage.setAsync("gemini-api-key",i.apiKey)}catch(e){console.error("APIキー保存エラー:",e)}else if("get-model-settings"===i.type)try{const e={selectedModelId:(yield figma.clientStorage.getAsync("selected-model-id"))||"gemini-2-5-pro",customModelId:(yield figma.clientStorage.getAsync("custom-model-id"))||"",showCustomModelInput:(yield figma.clientStorage.getAsync("show-custom-model"))||!1,generateWidth:(yield figma.clientStorage.getAsync("generate-width"))||"auto",generateHeight:(yield figma.clientStorage.getAsync("generate-height"))||"auto",includeChildren:(yield figma.clientStorage.getAsync("include-children"))||!1,includeImages:(yield figma.clientStorage.getAsync("include-images"))||!1,basePrompt:(yield figma.clientStorage.getAsync("base-prompt"))||""};figma.ui.postMessage({type:"model-settings-result",settings:e})}catch(e){console.error("モデル設定取得エラー:",e),figma.ui.postMessage({type:"model-settings-result",settings:{selectedModelId:"gemini-2-5-pro",customModelId:"",showCustomModelInput:!1,generateWidth:"auto",generateHeight:"auto",includeChildren:!1,includeImages:!1,basePrompt:""}})}else if("save-model-settings"===i.type)try{const{selectedModelId:e,customModelId:t,showCustomModelInput:n,generateWidth:a,generateHeight:r,includeChildren:s,includeImages:o,basePrompt:c}=i;yield figma.clientStorage.setAsync("selected-model-id",e),yield figma.clientStorage.setAsync("custom-model-id",t),yield figma.clientStorage.setAsync("show-custom-model",n),yield figma.clientStorage.setAsync("generate-width",a),yield figma.clientStorage.setAsync("generate-height",r),void 0!==s&&(yield figma.clientStorage.setAsync("include-children",s)),void 0!==o&&(yield figma.clientStorage.setAsync("include-images",o)),void 0!==c&&(yield figma.clientStorage.setAsync("base-prompt",c))}catch(e){console.error("モデル設定保存エラー:",e)}else if("get-page-data"===i.type)try{const e=function(){const e={name:figma.currentPage.name,id:figma.currentPage.id,backgroundColor:figma.currentPage.backgrounds,children:[],analysis:{}},t=figma.currentPage.children.filter((e=>"FRAME"===e.type||"COMPONENT"===e.type||"INSTANCE"===e.type)),i=t.slice(0,10);e.children=i.map((e=>{const t={id:e.id,name:e.name,type:e.type,width:e.width,height:e.height,textContent:[]};if("fills"in e)try{t.fills=e.fills}catch(e){console.error("Error getting fills:",e)}const i=[];function n(e){if("TEXT"===e.type)try{const t=e;i.push({id:t.id,characters:t.characters,fontSize:t.fontSize,fontName:t.fontName,x:t.x,y:t.y,width:t.width,height:t.height,fills:t.fills})}catch(e){console.error("Error processing text node:",e)}if("children"in e){const t=e;for(const e of t.children)n(e)}}if("children"in e)try{const t=e;for(const e of t.children)n(e)}catch(e){console.error("Error traversing frame children:",e)}return t.textContent=i.slice(0,20),t}));const n={};function a(e){if("fills"in e)try{const t=e;Array.isArray(t.fills)&&t.fills.forEach((e=>{if("SOLID"===e.type){const{r:t,g:i,b:a}=e.color,r=`rgb(${Math.round(255*t)}, ${Math.round(255*i)}, ${Math.round(255*a)})`;n[r]=(n[r]||0)+1}}))}catch(e){}if("children"in e)try{const t=e;for(const e of t.children)a(e)}catch(e){}}for(const e of figma.currentPage.children)a(e);const r=Object.entries(n).sort(((e,t)=>t[1]-e[1])).slice(0,10).map((([e,t])=>({color:e,count:t})));return e.analysis={frameCount:t.length,topColors:r},e}();figma.ui.postMessage({type:"page-data-result",pageData:e})}catch(e){console.error("ページデータ収集エラー:",e),figma.ui.postMessage({type:"page-data-result",pageData:{name:figma.currentPage.name,error:"ページデータの収集中にエラーが発生しました"},error:e instanceof Error?e.message:String(e)})}else if("insert-svg"===i.type)try{const e=figma.createNodeFromSvg(i.svg);i.width&&i.height&&e.resize(i.width,i.height),i.isBatchGeneration&&i.batchItemTitle?e.name=`${i.batchItemTitle} (${i.batchIndex+1}/${i.batchTotal})`:e.name="Generated SVG";const t=figma.viewport.center;e.x=t.x-e.width/2,e.y=t.y-e.height/2,figma.currentPage.selection=[e],figma.viewport.scrollAndZoomIntoView([e]),figma.ui.postMessage({type:"svg-inserted",success:!0,nodeId:e.id,isBatchGeneration:i.isBatchGeneration,batchIndex:i.batchIndex})}catch(e){figma.ui.postMessage({type:"svg-inserted",success:!1,error:e instanceof Error?e.message:String(e),isBatchGeneration:i.isBatchGeneration})}else if("insert-image"===i.type)try{const e=i.imageData;if(!e)throw new Error("画像データがありません");const t=figma.createRectangle(),n=e.split(",")[1],a=figma.base64Decode(n),r={type:"IMAGE",scaleMode:"FILL",imageHash:figma.createImage(a).hash};if(t.fills=[r],i.width&&i.height){const e=parseFloat(i.width),n=parseFloat(i.height);!isNaN(e)&&!isNaN(n)&&e>0&&n>0?(console.log(`画像挿入: サイズ=${e}x${n}, アスペクト比=${i.aspectRatio||"未指定"}`),t.resize(e,n),i.aspectRatio?t.name=`Generated Image (${i.aspectRatio})`:t.name="Generated Image"):(t.resize(500,500),t.name="Generated Image (Default Size)")}else t.resize(500,500),t.name="Generated Image (Default Size)";const s=figma.viewport.center;t.x=s.x-t.width/2,t.y=s.y-t.height/2,figma.currentPage.selection=[t],figma.viewport.scrollAndZoomIntoView([t]),figma.ui.postMessage({type:"image-inserted",success:!0})}catch(e){figma.ui.postMessage({type:"image-inserted",success:!1,error:e instanceof Error?e.message:String(e)})}else if("get-updated-tokens"===i.type)figma.ui.postMessage({type:"updated-tokens",designTokens:t()});else if("notify"===i.type)figma.notify(i.message);else if("resize-ui"===i.type)figma.ui.resize(i.width,i.height);else if("close-plugin"===i.type)figma.closePlugin(i.message);else if("save-coding-prompt"===i.type)try{yield figma.clientStorage.setAsync("coding-prompt",i.codingPrompt),figma.notify("コーディングプロンプトを保存しました")}catch(e){console.error("コーディングプロンプト保存エラー:",e),figma.notify("コーディングプロンプトの保存に失敗しました",{error:!0})}else if("get-coding-prompt"===i.type)try{const e=(yield figma.clientStorage.getAsync("coding-prompt"))||"FLOCSS";figma.ui.postMessage({type:"coding-prompt-result",codingPrompt:e})}catch(e){console.error("コーディングプロンプト取得エラー:",e),figma.ui.postMessage({type:"coding-prompt-result",codingPrompt:"FLOCSS"})}else if("get-selection-with-template-type"===i.type)try{const e=(yield figma.clientStorage.getAsync("include-children"))||!1,t=(yield figma.clientStorage.getAsync("include-images"))||!1,n=i.templateType,r=yield a(e,t,n);figma.ui.postMessage({type:"selection-with-template-type-result",selection:r,templateType:n})}catch(e){console.error("テンプレートタイプ付き選択情報取得エラー:",e),figma.notify("選択情報の取得中にエラーが発生しました",{error:!0})}}))}})[168]();