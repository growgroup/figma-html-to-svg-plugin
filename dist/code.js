({168:function(){var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};function t(){return{colors:figma.getLocalPaintStyles().map((e=>({name:e.name,description:e.description,paints:e.paints.map((e=>{if("SOLID"===e.type){const{r:t,g:i,b:n}=e.color;return{type:"SOLID",color:{r:Math.round(255*t),g:Math.round(255*i),b:Math.round(255*n),a:e.opacity||1}}}return{type:e.type}}))}))),texts:figma.getLocalTextStyles().map((e=>({name:e.name,description:e.description,fontName:e.fontName,fontSize:e.fontSize,letterSpacing:e.letterSpacing,lineHeight:e.lineHeight,paragraphIndent:e.paragraphIndent,paragraphSpacing:e.paragraphSpacing,textCase:e.textCase,textDecoration:e.textDecoration}))),effects:figma.getLocalEffectStyles().map((e=>({name:e.name,description:e.description,effects:e.effects})))}}function i(e){const t={id:e.id,name:e.name,type:e.type,visible:e.visible};let n=Object.assign({},t);if("fills"in e&&Array.isArray(e.fills))try{n.fills=e.fills}catch(e){console.error("Error getting fills:",e)}if("TEXT"===e.type)try{const t=e;n.characters=t.characters,n.fontSize=t.fontSize,n.fontName=t.fontName}catch(e){console.error("Error getting text properties:",e)}const o=e.absoluteBoundingBox;o&&(n.width=o.width,n.height=o.height,n.x=o.x,n.y=o.y);const r=e;if("children"in e&&Array.isArray(r.children))try{const e=10,t=Array.from(r.children).slice(0,e).map((e=>i(e)));n.children=t,n.childrenCount=r.children.length,n.truncated=r.children.length>e}catch(e){console.error("Error processing children:",e)}return n}function n(t){return e(this,void 0,void 0,(function*(){try{const e=yield t.exportAsync({format:"PNG",constraint:{type:"SCALE",value:1}});return`data:image/png;base64,${figma.base64Encode(e)}`}catch(e){return console.error("Error exporting node:",e),null}}))}function o(t){return e(this,void 0,void 0,(function*(){let e={name:t.name,id:t.id,type:t.type};if("TEXT"===t.type)try{e.textContent=t.characters}catch(e){console.error("テキストコンテンツ取得エラー:",e)}if("children"in t){const i=[];for(const e of t.children){const t=yield o(e);t&&i.push(t)}i.length>0&&(e.children=i)}return e}))}function r(t=!1,r=!1,c){return e(this,void 0,void 0,(function*(){try{const e=1e4;figma.currentPage.selection.some((e=>"INSTANCE"===e.type&&(!e.mainComponent||"symbol"==typeof e.mainComponent)))&&console.log("シリアライズできないインスタンスを検出しました。安全モードで処理します。");const l=figma.currentPage.selection.filter((t=>!("width"in t&&"height"in t&&(t.width>e||t.height>4*e)&&(console.log(`スキップ: 要素 "${t.name}" (${t.id}) は大きすぎます (${t.width}x${t.height}px)`),1))));if(l.length<figma.currentPage.selection.length){const t=figma.currentPage.selection.length-l.length;console.log(`${t}個の大きすぎる要素をスキップしました`),figma.notify(`${t}個の大きすぎる要素（${e}px以上）をスキップしました`,{timeout:3e3})}const g=l.map((e=>{try{const t={id:e.id,name:e.name,type:e.type,visible:e.visible};if("fills"in e)try{const i=Array.isArray(e.fills)?e.fills.map((e=>e&&"SOLID"===e.type&&e.color?{type:e.type,color:{r:e.color.r,g:e.color.g,b:e.color.b},opacity:e.opacity}:{type:e?e.type:"unknown"})):[];return Object.assign(Object.assign({},t),{fills:i})}catch(e){return console.error("fills処理エラー:",e),t}if("characters"in e)try{const i=e;return Object.assign(Object.assign({},t),{characters:i.characters,fontSize:i.fontSize||"unknown",fontWeight:i.fontWeight||"unknown",fontName:"object"==typeof i.fontName&&i.fontName?{family:"family"in i.fontName?i.fontName.family:"unknown",style:"style"in i.fontName?i.fontName.style:"unknown"}:{family:"unknown",style:"unknown"}})}catch(e){return console.error("テキストノード処理エラー:",e),t}return t}catch(t){return console.error("基本情報取得エラー:",t),{id:e.id||"unknown-id",name:e.name||"unknown-name",type:e.type||"unknown-type"}}}));if("research"===c)try{console.log("リサーチモード: テキスト情報を収集します");const e=l.map((e=>o(e))),s=yield Promise.all(e),a=g.map(((e,t)=>Object.assign(Object.assign({},e),{allTextContent:s[t]})));if(t)try{const e=l.map((e=>i(e))),t=a.map(((t,i)=>Object.assign(Object.assign({},t),{hierarchy:e[i]})));if(r)try{const e=l.map((e=>n(e))),i=yield Promise.all(e),o=t.map(((e,t)=>Object.assign(Object.assign({},e),{imageData:i[t]})));return JSON.parse(JSON.stringify(o,((e,t)=>"imageData"===e&&"string"==typeof t&&t.startsWith("data:image")?t:"symbol"==typeof t?null:t)))}catch(e){return console.error("画像含む階層情報取得エラー:",e),t}return JSON.parse(JSON.stringify(t,((e,t)=>"symbol"==typeof t?null:t)))}catch(e){return console.error("階層情報処理エラー:",e),a}if(r)try{const e=l.map((e=>n(e))),t=yield Promise.all(e),i=a.map(((e,i)=>Object.assign(Object.assign({},e),{imageData:t[i]})));return JSON.parse(JSON.stringify(i,((e,t)=>"imageData"===e&&"string"==typeof t&&t.startsWith("data:image")?t:"symbol"==typeof t?null:t)))}catch(e){return console.error("画像情報処理エラー:",e),a}return JSON.parse(JSON.stringify(a,((e,t)=>"symbol"==typeof t?null:t)))}catch(e){console.error("テキスト情報収集エラー:",e)}if("coding"===c){const e=l.map((e=>{try{return s(e)}catch(t){return console.error("詳細情報取得エラー:",t,e),{id:e.id,name:e.name,type:e.type,error:"データ取得エラー"}}})),i=g.map(((t,i)=>Object.assign(Object.assign({},t),{detailedStyles:e[i]})));if(t)try{const e=l.map((e=>{try{return a(e)}catch(t){return console.error("階層情報取得エラー:",t,e),{id:e.id,name:e.name,type:e.type,error:"階層データ取得エラー"}}})),t=i.map(((t,i)=>Object.assign(Object.assign({},t),{hierarchy:e[i]})));if(r)try{const e=l.map((e=>n(e))),i=yield Promise.all(e),o=t.map(((e,t)=>Object.assign(Object.assign({},e),{imageData:i[t]})));return JSON.parse(JSON.stringify(o,((e,t)=>"imageData"===e&&"string"==typeof t&&t.startsWith("data:image")?t:"symbol"==typeof t?null:t)))}catch(e){return console.error("画像含む階層情報取得エラー:",e),t.map((e=>Object.assign(Object.assign({},e),{error:"画像取得エラー"})))}return JSON.parse(JSON.stringify(t,((e,t)=>"symbol"==typeof t?null:t)))}catch(e){return console.error("階層情報処理エラー:",e),i}if(r)try{const e=l.map((e=>n(e))),t=yield Promise.all(e),o=i.map(((e,i)=>Object.assign(Object.assign({},e),{imageData:t[i]})));return JSON.parse(JSON.stringify(o,((e,t)=>"imageData"===e&&"string"==typeof t&&t.startsWith("data:image")?t:"symbol"==typeof t?null:t)))}catch(e){return console.error("画像情報処理エラー:",e),i}return JSON.parse(JSON.stringify(i,((e,t)=>"symbol"==typeof t?null:t)))}if(t)try{const e=l.map((e=>i(e))),t=g.map(((t,i)=>Object.assign(Object.assign({},t),{hierarchy:e[i]})));if(r)try{const e=l.map((e=>n(e))),i=yield Promise.all(e),o=t.map(((e,t)=>Object.assign(Object.assign({},e),{imageData:i[t]})));return JSON.parse(JSON.stringify(o,((e,t)=>"imageData"===e&&"string"==typeof t&&t.startsWith("data:image")?t:"symbol"==typeof t?null:t)))}catch(e){return console.error("画像含む階層情報処理エラー:",e),t}return JSON.parse(JSON.stringify(t,((e,t)=>"symbol"==typeof t?null:t)))}catch(e){return console.error("階層情報処理エラー:",e),g}if(r)try{const e=l.map((e=>n(e))),t=yield Promise.all(e),i=g.map(((e,i)=>Object.assign(Object.assign({},e),{imageData:t[i]})));return JSON.parse(JSON.stringify(i,((e,t)=>"imageData"===e&&"string"==typeof t&&t.startsWith("data:image")?t:"symbol"==typeof t?null:t)))}catch(e){return console.error("画像情報処理エラー:",e),g}return JSON.parse(JSON.stringify(g,((e,t)=>"symbol"==typeof t?null:t)))}catch(e){return console.error("選択情報取得エラー:",e),figma.currentPage.selection.map((e=>({id:e.id,name:e.name,type:e.type,skipped:"width"in e&&"height"in e&&(e.width>1e4||e.height>4e4)})))}}))}function s(e){try{const t={};if("absoluteBoundingBox"in e&&e.absoluteBoundingBox?t.bounds={x:e.absoluteBoundingBox.x,y:e.absoluteBoundingBox.y,width:e.absoluteBoundingBox.width,height:e.absoluteBoundingBox.height}:"x"in e&&"y"in e&&"width"in e&&"height"in e&&(t.bounds={x:e.x,y:e.y,width:e.width,height:e.height}),"FRAME"===e.type||"GROUP"===e.type||"INSTANCE"===e.type){const i=e;if("layoutMode"in i&&(t.layout={mode:i.layoutMode,direction:"layoutDirection"in i?i.layoutDirection:null,alignment:"primaryAxisAlignItems"in i?{primaryAxis:i.primaryAxisAlignItems,counterAxis:i.counterAxisAlignItems}:null,padding:"paddingTop"in i?{top:i.paddingTop,right:i.paddingRight,bottom:i.paddingBottom,left:i.paddingLeft}:null,spacing:"itemSpacing"in i?i.itemSpacing:null}),"backgrounds"in i&&Array.isArray(i.backgrounds))try{const e=i.backgrounds.map((e=>"SOLID"===e.type?{type:e.type,color:e.color?{r:e.color.r,g:e.color.g,b:e.color.b}:void 0,opacity:e.opacity}:{type:e.type}));t.backgrounds=e}catch(e){console.error("背景情報処理エラー:",e)}if("effects"in i&&Array.isArray(i.effects))try{const e=i.effects.map((e=>({type:e.type,visible:e.visible,radius:e.radius})));t.effects=e}catch(e){console.error("エフェクト情報処理エラー:",e)}if("strokes"in i&&Array.isArray(i.strokes)){try{const e=i.strokes.map((e=>"SOLID"===e.type?{type:e.type,color:e.color?{r:e.color.r,g:e.color.g,b:e.color.b}:void 0,opacity:e.opacity}:{type:e.type}));t.strokes=e}catch(e){console.error("ストローク情報処理エラー:",e)}"strokeWeight"in i&&(t.strokeWeight=i.strokeWeight),"strokeAlign"in i&&(t.strokeAlign=i.strokeAlign)}"cornerRadius"in i&&(t.cornerRadius=i.cornerRadius)}if("TEXT"===e.type){const i=e;if(t.text={characters:i.characters,fontSize:i.fontSize,fontName:{family:"object"==typeof i.fontName&&"family"in i.fontName?i.fontName.family:"unknown",style:"object"==typeof i.fontName&&"style"in i.fontName?i.fontName.style:"unknown"},fontWeight:i.fontWeight,letterSpacing:"object"==typeof i.letterSpacing&&"value"in i.letterSpacing?{value:i.letterSpacing.value,unit:i.letterSpacing.unit}:i.letterSpacing,lineHeight:"object"==typeof i.lineHeight?Object.assign(Object.assign({},"value"in i.lineHeight?{value:i.lineHeight.value}:{}),"unit"in i.lineHeight?{unit:i.lineHeight.unit}:{}):i.lineHeight,paragraphIndent:i.paragraphIndent,paragraphSpacing:i.paragraphSpacing,textAlignHorizontal:i.textAlignHorizontal,textAlignVertical:i.textAlignVertical,textCase:i.textCase,textDecoration:i.textDecoration,textAutoResize:i.textAutoResize},"fills"in i&&Array.isArray(i.fills))try{const e=i.fills.map((e=>"SOLID"===e.type?{type:e.type,color:e.color?{r:e.color.r,g:e.color.g,b:e.color.b}:void 0,opacity:e.opacity}:{type:e.type}));t.text.fills=e}catch(e){console.error("テキストfills情報処理エラー:",e)}}if("VECTOR"===e.type||"LINE"===e.type||"ELLIPSE"===e.type||"POLYGON"===e.type||"STAR"===e.type||"RECTANGLE"===e.type){if("fills"in e&&Array.isArray(e.fills))try{const i=e.fills.map((e=>"SOLID"===e.type?{type:e.type,color:e.color?{r:e.color.r,g:e.color.g,b:e.color.b}:void 0,opacity:e.opacity}:{type:e.type}));t.fills=i}catch(e){console.error("fills情報処理エラー:",e)}if("strokes"in e&&Array.isArray(e.strokes)){try{const i=e.strokes.map((e=>"SOLID"===e.type?{type:e.type,color:e.color?{r:e.color.r,g:e.color.g,b:e.color.b}:void 0,opacity:e.opacity}:{type:e.type}));t.strokes=i}catch(e){console.error("ストローク情報処理エラー:",e)}"strokeWeight"in e&&(t.strokeWeight=e.strokeWeight),"strokeAlign"in e&&(t.strokeAlign=e.strokeAlign)}"RECTANGLE"===e.type&&"cornerRadius"in e&&(t.cornerRadius=e.cornerRadius)}if(("COMPONENT"===e.type||"INSTANCE"===e.type)&&(t.component={id:e.id,name:e.name},"INSTANCE"===e.type)){const i=e;if("componentId"in i&&(t.component.componentId=i.componentId),i.mainComponent)try{t.component.mainComponent={id:i.mainComponent.id,name:i.mainComponent.name,type:i.mainComponent.type},i.mainComponent.width&&i.mainComponent.height&&(t.component.mainComponent.width=i.mainComponent.width,t.component.mainComponent.height=i.mainComponent.height)}catch(e){console.error("元コンポーネント情報取得エラー:",e)}if("componentProperties"in i&&i.componentProperties)try{const e={};Object.entries(i.componentProperties).forEach((([t,i])=>{e[t]={type:i.type,value:i.value}})),t.component.properties=e}catch(e){console.error("コンポーネントプロパティ処理エラー:",e)}}return JSON.parse(JSON.stringify(t))}catch(t){return console.error("詳細情報取得エラー:",t),{id:e.id,type:e.type,name:e.name}}}function a(e){try{const t=i(e),n=s(e),o=Object.assign(Object.assign({},t),{detailedStyles:n}),r=e;if("children"in e&&Array.isArray(r.children))try{const e=10,t=Array.from(r.children).slice(0,e).map((e=>a(e)));o.children=t,o.childrenCount=r.children.length,o.truncated=r.children.length>e}catch(e){console.error("Error processing children with styles:",e)}return JSON.parse(JSON.stringify(o))}catch(t){return console.error("再帰的詳細情報取得エラー:",t),{id:e.id,type:e.type,name:e.name}}}function c(){const e=[];function t(i){"visible"in i&&i.visible&&"id"in i&&e.push(i),"children"in i&&i.children.forEach((e=>t(e)))}return figma.currentPage.children.forEach((e=>t(e))),e}function l(t,i=!1,o=!1){return e(this,void 0,void 0,(function*(){const e=[t],r=[];for(const t of e){const e={id:t.id,name:t.name,type:t.type};if("width"in t&&"height"in t&&(e.width=t.width,e.height=t.height),i&&"children"in t&&(e.children=s(t)),o)try{e.imageData=yield n(t)}catch(e){console.error("画像エクスポートエラー:",e)}r.push(e)}return r}))}function g(t){return e(this,void 0,void 0,(function*(){const e=[];if("RECTANGLE"!==t.type&&"ELLIPSE"!==t.type&&"POLYGON"!==t.type&&"STAR"!==t.type&&"VECTOR"!==t.type&&"FRAME"!==t.type||"fills"in t&&Array.isArray(t.fills)&&t.fills.some((e=>"IMAGE"===e.type&&!1!==e.visible))&&e.push({node:t,reason:"IMAGE_FILL"}),"type"in t&&"IMAGE"===t.type&&e.push({node:t,reason:"IMAGE_NODE"}),"children"in t)for(const i of t.children){const t=yield g(i);e.push(...t)}return e}))}figma.showUI(__html__,{width:550,height:600}),figma.on("selectionchange",(()=>e(this,void 0,void 0,(function*(){try{const e=(yield figma.clientStorage.getAsync("include-children"))||!1,t=(yield figma.clientStorage.getAsync("include-images"))||!1,i=yield r(e,t);figma.ui.postMessage({type:"selection-update",selection:i})}catch(e){console.error("Error in selectionchange handler:",e),figma.ui.postMessage({type:"selection-update",selection:figma.currentPage.selection.map((e=>({id:e.id,name:e.name,type:e.type})))})}})))),figma.clientStorage.getAsync("gemini-api-key").then((e=>{figma.ui.postMessage({type:"api-key",apiKey:e||""})})),figma.clientStorage.getAsync("coding-prompt").then((e=>{figma.ui.postMessage({type:"coding-prompt",codingPrompt:e||"FLOCSS"})})),figma.ui.onmessage=i=>e(this,void 0,void 0,(function*(){if("ui-loaded"===i.type){console.log("UI loaded successfully");try{const e=(yield figma.clientStorage.getAsync("include-children"))||!1,i=(yield figma.clientStorage.getAsync("include-images"))||!1,n=(yield figma.clientStorage.getAsync("coding-prompt"))||"FLOCSS",o="coding",s=yield r(e,i,o);figma.ui.postMessage({type:"init-data",designTokens:t(),selection:s}),figma.ui.postMessage({type:"coding-prompt",codingPrompt:n})}catch(e){console.error("Error sending initial data:",e),figma.ui.postMessage({type:"init-data",designTokens:t(),selection:figma.currentPage.selection.map((e=>({id:e.id,name:e.name,type:e.type})))})}}else if("update-selection-settings"===i.type){const{includeChildren:e,includeImages:t,templateType:n}=i;yield figma.clientStorage.setAsync("include-children",e),yield figma.clientStorage.setAsync("include-images",t);try{const i=yield r(e,t,n);figma.ui.postMessage({type:"selection-update",selection:i})}catch(e){console.error("Error updating selection with new settings:",e),figma.notify("選択情報の更新中にエラーが発生しました",{error:!0})}}else if("get-api-key"===i.type)try{const e=(yield figma.clientStorage.getAsync("gemini-api-key"))||"";figma.ui.postMessage({type:"api-key-result",apiKey:e})}catch(e){console.error("APIキー取得エラー:",e),figma.ui.postMessage({type:"api-key-result",apiKey:""})}else if("save-api-key"===i.type)try{yield figma.clientStorage.setAsync("gemini-api-key",i.apiKey)}catch(e){console.error("APIキー保存エラー:",e)}else if("get-model-settings"===i.type)try{const e={selectedModelId:(yield figma.clientStorage.getAsync("selected-model-id"))||"gemini-2-5-pro",customModelId:(yield figma.clientStorage.getAsync("custom-model-id"))||"",showCustomModelInput:(yield figma.clientStorage.getAsync("show-custom-model"))||!1,generateWidth:(yield figma.clientStorage.getAsync("generate-width"))||"auto",generateHeight:(yield figma.clientStorage.getAsync("generate-height"))||"auto",includeChildren:(yield figma.clientStorage.getAsync("include-children"))||!1,includeImages:(yield figma.clientStorage.getAsync("include-images"))||!1,basePrompt:(yield figma.clientStorage.getAsync("base-prompt"))||""};figma.ui.postMessage({type:"model-settings-result",settings:e})}catch(e){console.error("モデル設定取得エラー:",e),figma.ui.postMessage({type:"model-settings-result",settings:{selectedModelId:"gemini-2-5-pro",customModelId:"",showCustomModelInput:!1,generateWidth:"auto",generateHeight:"auto",includeChildren:!1,includeImages:!1,basePrompt:""}})}else if("save-model-settings"===i.type)try{const{selectedModelId:e,customModelId:t,showCustomModelInput:n,generateWidth:o,generateHeight:r,includeChildren:s,includeImages:a,basePrompt:c}=i;yield figma.clientStorage.setAsync("selected-model-id",e),yield figma.clientStorage.setAsync("custom-model-id",t),yield figma.clientStorage.setAsync("show-custom-model",n),yield figma.clientStorage.setAsync("generate-width",o),yield figma.clientStorage.setAsync("generate-height",r),void 0!==s&&(yield figma.clientStorage.setAsync("include-children",s)),void 0!==a&&(yield figma.clientStorage.setAsync("include-images",a)),void 0!==c&&(yield figma.clientStorage.setAsync("base-prompt",c))}catch(e){console.error("モデル設定保存エラー:",e)}else if("get-page-data"===i.type)try{const e=function(){const e={name:figma.currentPage.name,id:figma.currentPage.id,backgroundColor:figma.currentPage.backgrounds,children:[],analysis:{}},t=figma.currentPage.children.filter((e=>"FRAME"===e.type||"COMPONENT"===e.type||"INSTANCE"===e.type)),i=t.slice(0,10);e.children=i.map((e=>{const t={id:e.id,name:e.name,type:e.type,width:e.width,height:e.height,textContent:[]};if("fills"in e)try{t.fills=e.fills}catch(e){console.error("Error getting fills:",e)}const i=[];function n(e){if("TEXT"===e.type)try{const t=e;i.push({id:t.id,characters:t.characters,fontSize:t.fontSize,fontName:t.fontName,x:t.x,y:t.y,width:t.width,height:t.height,fills:t.fills})}catch(e){console.error("Error processing text node:",e)}if("children"in e){const t=e;for(const e of t.children)n(e)}}if("children"in e)try{const t=e;for(const e of t.children)n(e)}catch(e){console.error("Error traversing frame children:",e)}return t.textContent=i.slice(0,20),t}));const n={};function o(e){if("fills"in e)try{const t=e;Array.isArray(t.fills)&&t.fills.forEach((e=>{if("SOLID"===e.type){const{r:t,g:i,b:o}=e.color,r=`rgb(${Math.round(255*t)}, ${Math.round(255*i)}, ${Math.round(255*o)})`;n[r]=(n[r]||0)+1}}))}catch(e){}if("children"in e)try{const t=e;for(const e of t.children)o(e)}catch(e){}}for(const e of figma.currentPage.children)o(e);const r=Object.entries(n).sort(((e,t)=>t[1]-e[1])).slice(0,10).map((([e,t])=>({color:e,count:t})));return e.analysis={frameCount:t.length,topColors:r},e}();figma.ui.postMessage({type:"page-data-result",pageData:e})}catch(e){console.error("ページデータ収集エラー:",e),figma.ui.postMessage({type:"page-data-result",pageData:{name:figma.currentPage.name,error:"ページデータの収集中にエラーが発生しました"},error:e instanceof Error?e.message:String(e)})}else if("insert-svg"===i.type)try{const e=figma.createNodeFromSvg(i.svg);i.width&&i.height&&e.resize(i.width,i.height),i.isBatchGeneration&&i.batchItemTitle?e.name=`${i.batchItemTitle} (${i.batchIndex+1}/${i.batchTotal})`:e.name="Generated SVG";const t=figma.viewport.center;e.x=t.x-e.width/2,e.y=t.y-e.height/2,figma.currentPage.selection=[e],figma.viewport.scrollAndZoomIntoView([e]),figma.ui.postMessage({type:"svg-inserted",success:!0,nodeId:e.id,isBatchGeneration:i.isBatchGeneration,batchIndex:i.batchIndex})}catch(e){figma.ui.postMessage({type:"svg-inserted",success:!1,error:e instanceof Error?e.message:String(e),isBatchGeneration:i.isBatchGeneration})}else if("insert-image"===i.type)try{const e=i.imageData;if(!e)throw new Error("画像データがありません");const t=figma.createRectangle(),n=e.split(",")[1],o=figma.base64Decode(n),r={type:"IMAGE",scaleMode:"FILL",imageHash:figma.createImage(o).hash};if(t.fills=[r],i.width&&i.height){const e=parseFloat(i.width),n=parseFloat(i.height);!isNaN(e)&&!isNaN(n)&&e>0&&n>0?(console.log(`画像挿入: サイズ=${e}x${n}, アスペクト比=${i.aspectRatio||"未指定"}`),t.resize(e,n),i.aspectRatio?t.name=`Generated Image (${i.aspectRatio})`:t.name="Generated Image"):(t.resize(500,500),t.name="Generated Image (Default Size)")}else t.resize(500,500),t.name="Generated Image (Default Size)";const s=figma.viewport.center;t.x=s.x-t.width/2,t.y=s.y-t.height/2,figma.currentPage.selection=[t],figma.viewport.scrollAndZoomIntoView([t]),figma.ui.postMessage({type:"image-inserted",success:!0})}catch(e){figma.ui.postMessage({type:"image-inserted",success:!1,error:e instanceof Error?e.message:String(e)})}else if("get-updated-tokens"===i.type)figma.ui.postMessage({type:"updated-tokens",designTokens:t()});else if("notify"===i.type)figma.notify(i.message);else if("resize-ui"===i.type)figma.ui.resize(i.width,i.height);else if("close-plugin"===i.type)figma.closePlugin(i.message);else if("save-coding-prompt"===i.type)try{yield figma.clientStorage.setAsync("coding-prompt",i.codingPrompt),figma.notify("コーディングプロンプトを保存しました")}catch(e){console.error("コーディングプロンプト保存エラー:",e),figma.notify("コーディングプロンプトの保存に失敗しました",{error:!0})}else if("get-coding-prompt"===i.type)try{const e=(yield figma.clientStorage.getAsync("coding-prompt"))||"FLOCSS";figma.ui.postMessage({type:"coding-prompt-result",codingPrompt:e})}catch(e){console.error("コーディングプロンプト取得エラー:",e),figma.ui.postMessage({type:"coding-prompt-result",codingPrompt:"FLOCSS"})}else if("get-layers-list"===i.type)try{const e=c();figma.ui.postMessage({type:"layers-list-result",success:!0,layers:e.map((e=>({id:e.id,name:e.name,type:e.type})))})}catch(e){figma.ui.postMessage({type:"layers-list-result",success:!1,error:e instanceof Error?e.message:String(e)})}else if("get-layer-selection-info"===i.type)try{const e=i.layerId,t=figma.getNodeById(e);if(!t)throw new Error(`Layer with ID ${e} not found`);if(!("type"in t))throw new Error(`Node with ID ${e} is not a SceneNode`);{const n=t,o=yield l(n,i.includeChildren,i.includeImages);figma.ui.postMessage({type:"layer-selection-info-result",success:!0,layerId:e,selectionInfo:o})}}catch(e){figma.ui.postMessage({type:"layer-selection-info-result",success:!1,error:e instanceof Error?e.message:String(e)})}else if("export-elements-as-images"===i.type)try{const t=i.nodeIds.map((e=>figma.getNodeById(e))).filter((e=>null!==e&&"exportAsync"in e));if(0===t.length)return void figma.ui.postMessage({type:"export-images-result",success:!1,error:"No valid nodes found"});console.log(`Processing ${t.length} layers for image extraction`);const n=yield function(t){return e(this,void 0,void 0,(function*(){const e=[];for(const i of t)try{const t=yield g(i);if(0===t.length){const t=yield i.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),n=`data:image/png;base64,${figma.base64Encode(t)}`,o=i.name.replace(/[^\w\s]/gi,"_").trim()||"image";e.push({id:figma.createNodeFromJSXAsync?figma.createNodeFromJSXAsync.toString()+"_"+Math.random().toString(36).substring(2,11):Math.random().toString(36).substring(2,11),name:`${o}.png`,data:n,nodeId:i.id})}else for(const[n,o]of t.entries()){const t=o.node,r=yield t.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),s=`data:image/png;base64,${figma.base64Encode(r)}`;let a=t.name.replace(/[^\w\s]/gi,"_").trim();a||(a=`image_${n}`),e.push({id:t.id,name:`${a}.png`,data:s,nodeId:i.id})}}catch(e){console.error(`Error processing node ${i.name}:`,e)}return e}))}(t);console.log(`Extracted ${n.length} images from layers`),figma.ui.postMessage({type:"export-images-result",success:!0,images:n})}catch(e){console.error("Error exporting images:",e),figma.ui.postMessage({type:"export-images-result",success:!1,error:e instanceof Error?e.message:String(e)})}else if("get-selection-with-template-type"===i.type)try{const e=(yield figma.clientStorage.getAsync("include-children"))||!1,t=(yield figma.clientStorage.getAsync("include-images"))||!1,n=void 0!==i.includeChildren?i.includeChildren:e,o=void 0!==i.includeImages?i.includeImages:t,s=i.templateType;if(console.log(`選択情報の取得: テンプレートタイプ=${s}, 子要素を含む=${n}, 画像を含む=${o}`),0===figma.currentPage.selection.length)return figma.notify("選択された要素がありません。Figmaで要素を選択してください。"),void figma.ui.postMessage({type:"selection-with-template-type-result",selection:[],templateType:s,error:"選択要素がありません"});figma.currentPage.selection.some((e=>"INSTANCE"===e.type))&&console.log("選択にインスタンスが含まれています。データを慎重に処理します。");const a=yield r(n,o,s);figma.ui.postMessage({type:"selection-with-template-type-result",selection:a,templateType:s})}catch(e){const t=e instanceof Error?e.message:String(e);console.error("テンプレートタイプ付き選択情報取得エラー:",t);let n="選択情報の取得中にエラーが発生しました。";(t.includes("symbol")||t.includes("unwrap"))&&(n+=" コンポーネントインスタンスのデータを安全に処理できませんでした。"),figma.notify(n,{error:!0,timeout:5e3}),figma.ui.postMessage({type:"selection-with-template-type-result",selection:figma.currentPage.selection.map((e=>({id:e.id,name:e.name,type:e.type,error:"データ取得エラー"}))),templateType:i.templateType,error:t})}else if("get-single-element-info"===i.type)try{const e=i.elementId,t=figma.getNodeById(e);if(!t||!("type"in t))return console.error(`要素ID ${e} が見つからないか、有効なSceneNodeではありません`),void figma.ui.postMessage({type:"single-element-info-result",elementId:e,elementInfo:null,error:"要素が見つかりません"});console.log(`要素 ${t.name} (${t.id}) の詳細情報を取得します`);const n=void 0===i.includeChildren||i.includeChildren,r=void 0===i.includeImages||i.includeImages,s=i.templateType,a=t,c=yield l(a,n,r);if("research"===s){const e=yield o(a);c&&c.length>0&&(c[0].allTextContent=e)}figma.ui.postMessage({type:"single-element-info-result",elementId:e,elementInfo:c&&c.length>0?c[0]:null})}catch(e){const t=e instanceof Error?e.message:String(e);console.error(`要素情報取得エラー: ${t}`),figma.ui.postMessage({type:"single-element-info-result",elementId:i.elementId,elementInfo:null,error:t})}}))}})[168]();